<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
    *{
      padding: 0;
      margin: 0;
      list-style: none;
      box-sizing: border-box;
    }
    body{
      -webkit-overflow-scrolling: touch;
    }
    .wrap{
      position: relative;
      width: 100%;
      height: 100vh;
      overflow-y: scroll;
      -webkit-overflow-scrolling: auto;
    }
    .noTouch{
      -webkit-overflow-scrolling: auto;
    }
    .wrap:after{
      content: '';
      width: 0;
      display: block;
      clear: both;
    }
    .wrap > div{
      border: 1px solid #000;
      background: rgba(0,0,0,.3);
      width: calc(100% / 4);
      float: left;
      height: 120px;
      line-height: 120px;
      text-align: center;
      -webkit-touch-callout:none;
      -webkit-user-select:none;
      -khtml-user-select:none;
      -moz-user-select:none;
      -ms-user-select:none;
      user-select:none;
    }
    /* .item:after{
      content:'';
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      position: absolute;
      z-index: 1;
      background-color: rgba(255,0,0,.3);
    } */
    .item img{
      display: block;
      width: 100%;
      margin: auto;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
    <div class="item">
      <img src="http://cimg.pcstore.com.tw/cprd/C1151769810_big.jpg?pimg=static&P=1534573072" alt="">
    </div>
  </div>


<script src="bodyScrollLock.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="easing.js"></script>
<script src="ddsort.js"></script>
<script>
  //ğŸ‹ Apply -webkit-overflow-scrolling in Every TouchEnd

  
 
  (function(){
    var obj = {
    wrap: '.wrap', // ç©ºé–“ *
    target: '.item', // å¯ä»¥è¢«æ‹–æ›³çš„ç‰©ä»¶ *
    delay: 400, // å»¶é²å¤šä¹…æ‰è§¸ç™¼äº‹ä»¶ 
    // cloneStyle: {

    // },
    // floatStyle: {

    // },
    };

    // init apply
    myDragSort(obj);


    function myDragSort(params) {
      try {
        if(!params.wrap || !params.target) {
          console.log('params error=>',params);
        }
        // å¯ä»¥è¢«æ‹–æ›³ç‰©ä»¶
        var dragItems = params.target;
        var $dragItems = $(params.target);
        // è¦ç§»å‹•çš„æ»¾è¼ªç‰©ä»¶
        var scrollItem = params.wrap;
        var $scrollItem = $(params.wrap);
        // å»¶é²æ™‚é–“(æ¯«ç§’)
        var delayTime = params.delay || 0;

        // è¤‡è£½ä¸€å€‹å‡çš„item
        var cloneItem = {
          styles:{
            'background-color': '#a00',
          },
          className: 'fakeItem',
          clone: '',
        }
        // cloneItem.styles = params.cloneStyle ? params.cloneStyle : cloneItem.styles;
        var dragStyle = {
          'position': 'fixed', // fixed absolute
          'webkitTransform': 'rotate(3deg)',
          'mozTransform': 'rotate(3eg',
          'msTransform': 'rotate(3eg)',
          'transform': 'rotate(3deg)',
          'z-index': '2',
        }
        
        var iOS = /iPad|iPhone|iPod/.test(navigator.userAgent);


        // ios å¯èƒ½æœƒåº•éƒ¨è·é›¢ï¼Œéœ€è¦åŠ è·é›¢æ‰èƒ½è‡³åº•
        var distances= $('body').height() - $(window).height();
        if(distances !=0){
          // console.log('!0')
          $scrollItem.css({
            'padding-bottom': distances, 
          })
        } 

        
        // ç¢°è§¸é–‹å§‹æ™‚é–“
        var startTime = 0;
        // ç´€éŒ„èµ·å§‹é»
        var startPosition = { x : 0, y : 0 };
        // ç¾åœ¨ç›®å‰ç¢°è§¸ä½ç½®ç´€éŒ„
        var currentPosition = { x: 0, y: 0 };
        // ç§»å‹•å‰ä¸€å€‹é»
        var prePosition = { x : 0, y : 0 };
        // æ‹–æ›³ç‹€æ…‹
        var dragging = false;
        // æ˜¯å¦æœ‰è¤‡è£½å‡çš„Item
        var hasClone = false;
        // æš«å­˜ item åƒæ•¸
        var itemObject = {
          $this: '',  // this
          styles: '', // æ¨£å¼
        };
        // requestAnimationFrame
        var renderAnimation;
        var animationTime = 0;

        // æš«å­˜ç›®å‰scrollTop
        var scrollTopDis = 0;


        // item ç¸½æ•¸
        var itemSum = $scrollItem.find(dragItems).length;



        // 1. Get a target element that you want to persist scrolling for (such as a modal/lightbox/flyout/nav). 
        const targetElement = document.querySelector(scrollItem);
        
        
        // 2. ...in some event handler after showing the target element...disable body scroll
        bodyScrollLock.disableBodyScroll(targetElement);
        // bodyScrollLock.disableBodyScroll(targetElementBody);
          
        // 3. ...in some event handler after hiding the target element...
        // bodyScrollLock.enableBodyScroll(targetElement);
          
        // 4. Useful if we have called disableBodyScroll for multiple target elements,
        // and we just want a kill-switch to undo all that.
        // bodyScrollLock.clearAllBodyScrollLocks();

        
        var touchTimeout = '';
        var scrollInterval = '';

        var imageTouch = function(e){ e.preventDefault(); }


        var touchStart = function(e){
          // stop animate
          if(iOS) $scrollItem.stop(false, false);
          $(dragItems + ' > img').on('contextmenu', imageTouch);
          
          var e = e || event;
          // æ¡Œæ©Ÿ
          var pageX = e.pageX;
          var pageY = e.pageY;
          // ç§»å‹•ç«¯
          var targetTouches = e.originalEvent.targetTouches;
          if (e.type == 'touchstart' && targetTouches) {
              pageX = targetTouches[0].pageX;
              pageY = targetTouches[0].pageY;
          }
          // é–‹å§‹ç¢°è§¸ç´€éŒ„èµ·å§‹é»
          startPosition = { x: pageX, y: pageY };
          // è¨˜éŒ„æ™‚é–“
          startTime = new Date().getTime();
          // å°‡thisæš«å­˜
          itemObject.$this = $(this);
          // å–å‡ºè¢«é¸å–çš„æ¨£å¼
          itemObject.styles = {
            height: itemObject.$this.outerHeight(),
            width: itemObject.$this.outerWidth(),
          }
          // è¤‡è£½è¢«é»åˆ°çš„Itemï¼Œä¸¦ä¸”æŠŠå…§å®¹æ¸…é™¤
          cloneItem.clone = itemObject.$this.clone()
            .css(cloneItem.styles).css({
              left: pageX + itemObject.styles.height/2,
              top: pageY + itemObject.styles.width/2,
            })
            .empty();
          hasClone = true;

          // å»¶é²æ™‚é–“åˆ°ï¼Œæ²’è¢«æ¸…é™¤çš„è©±ï¼ŒæŠŠitem drag
          touchTimeout = setTimeout(function() {
            // console.log('delayTime arrives');
            itemObject.$this.before(cloneItem.clone.addClass(cloneItem.className)) // æ’å…¥å‡çš„item
              .css(dragStyle) // å¢åŠ drag style
              .css(itemObject.styles) // åŸæœ¬ item style
              .appendTo(itemObject.$this.parent()); // æ”¾åˆ°æœ€å¾Œä¸€å€‹
            hasClone = false;
            dragging = true;

            itemObject.$this.css({
              left: startPosition.x - itemObject.styles.width/2,
              top: startPosition.y - itemObject.styles.height/2,
            });
            // $scrollItem.addClass('noTouch');

          }, delayTime); 

          // è¨»å†Šmoveäº‹ä»¶
          $dragItems.on('touchmove', touchMove);
          $dragItems.on('touchend', touchEnd);
        }


        var touchMove = function(e){
          var e = e || event;
          // æ¡Œæ©Ÿ
          var pageX = e.pageX;
          var pageY = e.pageY;
          // ç§»å‹•ç«¯
          var targetTouches = e.originalEvent.targetTouches;
          if (e.type == 'touchmove' && targetTouches) {
            pageX = targetTouches[0].pageX;
            pageY = targetTouches[0].pageY;
          }
          // ç¾åœ¨ç›®å‰ç¢°è§¸ä½ç½®ç´€éŒ„
          currentPosition = { x: pageX, y: pageY };
          // console.log(currentPosition)

          var currentScroll = $scrollItem.scrollTop();
          scrollTopDis = currentScroll;

          // é˜²æ­¢è¡¨å–®åŠŸèƒ½å¤±æ•ˆ
          var tagName = e.target.tagName.toLowerCase();
          if (tagName == 'input' || tagName == 'textarea' || tagName == 'select' ||
              tagName == 'a' || $(e.target).prop('contenteditable') == 'true') return;
          if (new Date().getTime() - startTime < delayTime) {
            // å°æ–¼å»¶é²æ™‚é–“
            dragging = false;
            clearTimeout(touchTimeout);
            return;
          }else{
            // å¤§æ–¼å»¶é²æ™‚é–“ï¼Œå·²ç¶“ç§»å‹•scroll,åˆä¸æ˜¯dragging
            if( Math.abs(startPosition.y - currentPosition.y) > 20 && !dragging ){
              // console.log('æ­£åœ¨scrolling');
              clearTimeout(touchTimeout);
              return;
            }
          }

          dragging = true;
          // $scrollItem.addClass('noTouch');

          // æœ‰è¤‡è£½ç‰©ä»¶å‹•ä½œ
          if(hasClone){
            itemObject.$this.before(cloneItem.clone.addClass(cloneItem.className)) // æ’å…¥å‡çš„item
              .css(dragStyle) // å¢åŠ drag style
              .css(itemObject.styles) // åŸæœ¬ item style
              .appendTo(itemObject.$this.parent()); // æ”¾åˆ°æœ€å¾Œä¸€å€‹
            hasClone = false;
          }

          itemObject.$this.css({
            left: currentPosition.x - itemObject.styles.width/2,
            top: currentPosition.y - itemObject.styles.height/2,
          });

          
          // æ­£åœ¨è¢«æ‹–æ›³ç‰©ä»¶å‹•ç•«
          var render = function(t){
            var _time = t - animationTime;
            motion(_time);
            animationTime = t;
          }
          var motion = function(offset){
            if(Math.round(currentPosition.y) === startPosition.y) return;
            itemObject.$this.css({
              left: currentPosition.x - itemObject.styles.width/2,
              top: currentPosition.y - itemObject.styles.height/2,
            });
            // è¦–çª—ç§»å‹•çš„è·é›¢
            var disY = (currentPosition.y - startPosition.y); // <0 æ»‘åˆ°åˆ°è¦–çª—ä¸Šé¢ï¼Œ>0æ»‘åˆ°è¦–çª—ä¸‹é¢
            var disX = (currentPosition.x - startPosition.x); // <0 æ»‘åˆ°è¦–çª—å·¦é‚Šï¼Œ>0æ»‘åˆ°è¦–çª—å³é‚Š
            // console.log({ disX, disY })
            // console.log(currentPosition)
            // console.log(itemObject.styles.height)


            // method 1----start
            // è¦–çª—é«˜
            var windowHeight = $(window).height();
            // æ»¾åˆ°åº•è·é›¢ $('.wrap').prop('scrollHeight');
            // è¦–çª—å¯ç§»å‹•è·é›¢
            var maxWindowScroll = 0;
            
            if(disY > 0)  maxWindowScroll = startPosition.y; // èµ·å§‹é»è·é›¢topè·é›¢
            else if(disY < 0 ) maxWindowScroll = $(window).height() - startPosition.y; // èµ·å§‹é»è·é›¢bottomè·é›¢
            // ç§»å‹• wrap scroll ï¼Œè¦è¨­å®š wrap scrollTop ç”¨
            var moveScroll = '';
            // ç¸½ wrap scroll æœ€å¤§å€¼
            var maxMoveScroll = $scrollItem.prop('scrollHeight') - $('body').height();
            moveScroll = Math.abs($scrollItem.scrollTop()) / windowHeight * maxMoveScroll;

            // method 1----end


            // è§¸ç¢°é»ç›¸å° container çš„ä½ç½®
            var ContainerPosition = { x:0, y:0 };
            // itemObject.styles.height // item çš„é«˜åº¦
            // itemObject.styles.width // item çš„å¯¬åº¦

            ContainerPosition = {
              x: currentPosition.x,
              y: currentPosition.y + $scrollItem.scrollTop(),
            }
            // console.log(ContainerPosition)

            // å€æ•¸ (ä¸€åˆ—ä¹‹ä¸­æœ€å¤šå¹¾å€‹)
            var multiple = Math.abs($(window).width() / itemObject.styles.width);
            
            // æœ€å¤šæœ‰å¹¾åˆ—
            var maxCol = Math.ceil(itemSum/multiple);
            var row = Math.floor(ContainerPosition.y / itemObject.styles.height) + 1 > maxCol ? 
                    maxCol : Math.floor(ContainerPosition.y / itemObject.styles.height) + 1; // ç¬¬ n æ’
            var col = Math.floor(ContainerPosition.x / itemObject.styles.width) + 1 > multiple ? 
                    multiple : Math.floor(ContainerPosition.x / itemObject.styles.width) + 1; // ç¬¬ n åˆ—

            var row_dis = (ContainerPosition.y / itemObject.styles.height).toFixed(1).slice(2);
            var col_dis = (ContainerPosition.x / itemObject.styles.width).toFixed(1).slice(2);
            // console.log({row_dis, col_dis})
            

            // item ç¸½æ•¸ = itemSum
          
            var index = (row-1)*multiple + (col - 1);

            // console.log({ 
            //   row,
            //   col,
            //   index,
            //   text: $(scrollItem + ' ' + dragItems).eq(index).attr('class')
            // })

            // ç§»å‹•fake item


            if(index === (itemSum - 1) || $(scrollItem + ' ' + dragItems).eq(index -1).hasClass('fakeItem') ) {
              $(scrollItem + ' ' + dragItems).eq(index).after(cloneItem.clone);
            }
            else {
              $(scrollItem + ' ' + dragItems).eq(index).before(cloneItem.clone);
            }


            // var calc = {
            //   'è¦–çª—ç§»å‹•è·é›¢': disY,
            //   'å¯ç§»å‹•è·é›¢': maxWindowScroll,
            //   'wrap ç§»å‹• Scroll': maxWindowScroll,
            //   'wrap ç¸½ scroll': maxMoveScroll,
            // }

            // console.log(calc)
            // console.log(moveScroll)
            // console.log(currentPosition.y - prePosition.y)
            // currentPosition.y - prePosition.y < 0... çœ‹ä¸‹é¢å…§å®¹
            // currentPosition.y - prePosition.y > 0... çœ‹ä¸Šé¢å…§å®¹

            // method 1----start
            var curScrollTop = $scrollItem.scrollTop();
            // ç›®å‰scroll åŠ ä¸Š ç§»å‹•è·é›¢
            var scrollSum = (curScrollTop + disY);
            if(disY > 0){
              // çœ‹ä¸‹é¢å…§å®¹
              // console.log("å¾€ä¸Šé¢å…§å®¹", disY)
              // $scrollItem.scrollTop(moveScroll); // æ»¾è¼ªä¸€ç›´å‹•
            }else if(disY < 0){
              // çœ‹ä¸Šé¢å…§å®¹
              // console.log("å¾€ä¸‹é¢å…§å®¹", (cur + disY))
              // $scrollItem.scrollTop(moveScroll); // æ»¾è¼ªä¸€ç›´å‹•
            }else if(disY === 0){
              // å·¦å³æ»‘
              // console.log('å·¦å³æ»‘')
            }
            // çµ¦äºˆç´€éŒ„é»
            prePosition = currentPosition;
            // method 1----end


            // ç½®é ‚ è‡³åº• ç§»å‹• method2 ---start
            // issue wrap ä¸èƒ½ç”¨ css å±¬æ€§: -webkit-overflow-scrolling: touch;
            if( currentPosition.y - itemObject.styles.height  < 0) {
              // console.log('touch top');
              scrollTopDis = currentScroll - 10; // æ¯æ¬¡å›ºå®šç§»å‹•10
            }else if(currentPosition.y + itemObject.styles.height  > windowHeight){
              // console.log('touch bottom');
              scrollTopDis = currentScroll + 10; // æ¯æ¬¡å›ºå®šç§»å‹•10
            }else{
              // console.log('touch nothing');
            }
            $scrollItem.scrollTop(scrollTopDis);
            // ç½®é ‚ è‡³åº• ç§»å‹• method2 ---end

          }
          renderAnimation = requestAnimationFrame(render);
        }

        var touchEnd = function(e){
          clearTimeout(touchTimeout);
          clearInterval(scrollInterval);

          $(dragItems + ' > img').unbind('contextmenu', imageTouch);
          var e = e || event;

          // console.log('touch time=>',new Date().getTime() - startTime)
          var touchTime = new Date().getTime() - startTime;
          if(touchTime < 300 && !dragging && iOS){
            // currentPosition.y - prePosition.y < 0... çœ‹ä¸‹é¢å…§å®¹
            // currentPosition.y - prePosition.y > 0... çœ‹ä¸Šé¢å…§å®¹
            var touchDis = startPosition.y - currentPosition.y;
            // console.log(touchDis)
            // scroll animate
            $scrollItem.stop(false,false).animate({
              scrollTop: $scrollItem.scrollTop() + touchDis*5,
            }, {
              duration: touchTime*8,
              easing: 'easeOutQuint', //  easeOutCirc easeOutQuad easeOutQuint
            });
          }
          





          // $scrollItem.removeClass('noTouch');
          if(!hasClone) cloneItem.clone.before(itemObject.$this.removeAttr('style')).remove();
          if($('body').scrollTop() !==0 ) $('body').scrollTop(0);
          // å–æ¶ˆå‹•ç•«
          cancelAnimationFrame(renderAnimation);
          hasClone = false;
          // å–æ¶ˆè¨»å†Šäº‹ä»¶
          $dragItems.off('touchmove touchend');
        }
        // å…ˆè¨»å†Šä¸€æ¬¡startäº‹ä»¶
        $dragItems.on('touchstart', touchStart);

      } catch (error) {
        console.log("error=>", error);
      }
    }

  })();
</script>  
</body>
</html>